<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who's In the Erg Room?</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="/static/htmx.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Scanner Chatbox */
        .scanner-chatbox {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 100;
            width: clamp(200px, 25vw, 280px);
            display: flex;
            flex-direction: column;
            border: 3px ridge #4499D9;
            background: #FFFFFF;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .scanner-chatbox.collapsed .chatbox-log,
        .scanner-chatbox.collapsed .chatbox-input {
            display: none;
        }

        .chatbox-header {
            background: linear-gradient(180deg, #4499D9 0%, #2d6a99 100%);
            color: #FFFFFF;
            padding: 0.4rem 0.6rem;
            font-weight: bold;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border-bottom: 2px ridge #4499D9;
            cursor: pointer;
            user-select: none;
        }

        .chatbox-header:hover {
            background: linear-gradient(180deg, #5aaae6 0%, #3d8ac7 100%);
        }

        .chatbox-header .status-dot {
            width: 8px;
            height: 8px;
            background: #0f0;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        .chatbox-header .toggle-icon {
            margin-left: auto;
            font-size: 0.7rem;
            transition: transform 0.3s ease;
        }

        .scanner-chatbox.collapsed .chatbox-header .toggle-icon {
            transform: rotate(180deg);
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chatbox-log {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            background: #FFFFFF;
            min-height: 100px;
            max-height: 180px;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .chatbox-log::-webkit-scrollbar {
            width: 12px;
        }

        .chatbox-log::-webkit-scrollbar-track {
            background: #e0e0e0;
            border: 1px inset #ccc;
        }

        .chatbox-log::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4499D9 0%, #2d6a99 100%);
            border: 1px outset #5aaae6;
        }

        .chat-message {
            padding: 0.3rem 0.5rem;
            border-radius: 0;
            animation: slideInMessage 0.3s ease;
            border-left: 3px solid;
            background: rgba(68, 153, 217, 0.05);
        }

        .chat-message.in {
            border-left-color: #0a0;
            background: rgba(0, 170, 0, 0.1);
        }

        .chat-message.out {
            border-left-color: #a00;
            background: rgba(170, 0, 0, 0.1);
        }

        .chat-message.registered {
            border-left-color: #4499D9;
            background: rgba(68, 153, 217, 0.15);
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message .timestamp {
            color: #888;
            font-size: 0.7rem;
            font-family: 'Courier New', monospace;
        }

        .chat-message .content {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .chat-message .name {
            font-weight: bold;
            color: #4499D9;
        }

        .chat-message .action-text {
            color: #333;
        }

        .chat-message.in .action-text {
            color: #060;
        }

        .chat-message.out .action-text {
            color: #600;
        }

        .chat-message .icon {
            font-size: 1rem;
        }

        .chatbox-empty {
            color: #888;
            text-align: center;
            padding: 1rem;
            font-style: italic;
        }

        .chatbox-input {
            background: #e8e8e8;
            padding: 0.4rem 0.6rem;
            border-top: 2px ridge #4499D9;
            font-size: 0.75rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .chatbox-input .scan-icon {
            font-size: 1.1rem;
        }

        /* Flash effects on scan */
        .scanner-chatbox.flash-in {
            animation: chatFlashIn 0.5s ease;
        }

        .scanner-chatbox.flash-out {
            animation: chatFlashOut 0.5s ease;
        }

        @keyframes chatFlashIn {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 20px rgba(0, 170, 0, 0.6); }
        }

        @keyframes chatFlashOut {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 20px rgba(170, 0, 0, 0.6); }
        }

        /* Member list animations */
        .member-grid {
            transition: all 0.3s ease;
        }

        .member-item.new-checkin {
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Small screens */
        @media (max-width: 480px) {
            .scanner-chatbox {
                width: clamp(160px, 45vw, 220px);
                bottom: 4rem;
                right: 0.5rem;
                font-size: 0.75rem;
            }

            .chatbox-header {
                padding: 0.3rem 0.5rem;
                font-size: 0.75rem;
            }

            .chatbox-log {
                min-height: 80px;
                max-height: 140px;
                padding: 0.4rem;
            }

            .chat-message {
                padding: 0.2rem 0.4rem;
            }

            .chat-message .timestamp {
                font-size: 0.6rem;
            }

            .chatbox-input {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }
        }

        /* Large screens */
        @media (min-width: 1200px) {
            .scanner-chatbox {
                width: 320px;
            }

            .chatbox-log {
                max-height: 280px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/static/c150lion1.png" alt="C150 Lion" class="header-lion left">
            <h1>Who's In the Erg Room?</h1>
            <img src="/static/c150lion1.png" alt="C150 Lion" class="header-lion right">
        </div>
    </header>

    <section>
        <h2>Currently Here <span id="present-count">({{ present|length }})</span></h2>

        <div id="filter-controls" class="filter-controls">
            <button class="filter-btn active" data-category="all">All</button>
            <button class="filter-btn" data-category="LM">Lightweight</button>
            <button class="filter-btn" data-category="M">Heavyweight</button>
            <button class="filter-btn" data-category="W">Women</button>
        </div>

        <div id="present-list">
            {% include '_present_list.html' %}
        </div>
    </section>

    <div id="scanner-chatbox" class="scanner-chatbox collapsed">
        <div class="chatbox-header" onclick="toggleChatbox()">
            <span class="status-dot"></span>
            <span>Activity</span>
            <span class="toggle-icon">▼</span>
        </div>
        <div id="chatbox-log" class="chatbox-log">
            {% if scan_history %}
                {% for scan in scan_history %}
                <div class="chat-message {{ scan.action }}">
                    <div class="timestamp">{{ scan.timestamp[11:19] }}</div>
                    <div class="content">
                        <span class="icon">{% if scan.action == 'in' %}→{% elif scan.action == 'out' %}←{% else %}✨{% endif %}</span>
                        <span class="name">{{ scan.member_name or 'Unknown' }}</span>
                        <span class="action-text">{% if scan.action == 'in' %}checked in{% elif scan.action == 'out' %}checked out{% else %}registered{% endif %}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="chatbox-empty">Tap your tag to check in!</div>
            {% endif %}
        </div>
        <div class="chatbox-input">
            <span>Tap your card to check in/out</span>
        </div>
    </div>

    <footer>
        <a href="/login">Edit Profile</a>
        <a href="/admin/login">Admin</a>
    </footer>

    <script>
        let lastScanTimestamp = null;
        let pollInterval = 2000;
        let currentFilter = 'all';
        let lightweightMode = false;

        function toggleChatbox() {
            const chatbox = document.getElementById('scanner-chatbox');
            chatbox.classList.toggle('collapsed');
            localStorage.setItem('chatboxCollapsed', chatbox.classList.contains('collapsed'));
        }

        function formatTime(isoTimestamp) {
            if (!isoTimestamp) return '';
            return isoTimestamp.substring(11, 19);
        }

        async function checkForScans() {
            try {
                const response = await fetch('/api/scan_history');
                const history = await response.json();

                if (history.length > 0) {
                    const latestTimestamp = history[0].timestamp;

                    if (latestTimestamp !== lastScanTimestamp) {
                        const isNewScan = lastScanTimestamp !== null;
                        lastScanTimestamp = latestTimestamp;

                        updateChatbox(history);

                        if (isNewScan) {
                            flashChatbox(history[0].action);

                            if (history[0].action === 'in' || history[0].action === 'out') {
                                refreshPresentList();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking for scans:', error);
            }
        }

        function updateChatbox(history) {
            const chatLog = document.getElementById('chatbox-log');

            if (history.length === 0) {
                chatLog.innerHTML = '<div class="chatbox-empty">No activity yet...<br>Tap your tag to check in!</div>';
                return;
            }

            let html = '';
            for (const scan of history) {
                const icon = scan.action === 'in' ? '→' : (scan.action === 'out' ? '←' : '✨');
                const actionText = scan.action === 'in' ? 'checked in' : (scan.action === 'out' ? 'checked out' : 'registered');
                const name = scan.member_name || 'Unknown';

                html += `
                    <div class="chat-message ${scan.action}">
                        <div class="timestamp">${formatTime(scan.timestamp)}</div>
                        <div class="content">
                            <span class="icon">${icon}</span>
                            <span class="name">${name}</span>
                            <span class="action-text">${actionText}</span>
                        </div>
                    </div>
                `;
            }

            chatLog.innerHTML = html;
        }

        function flashChatbox(action) {
            const chatbox = document.getElementById('scanner-chatbox');

            chatbox.classList.remove('flash-in', 'flash-out');

            // Force reflow to restart CSS animation
            void chatbox.offsetWidth;

            if (action === 'in') {
                chatbox.classList.add('flash-in');
            } else if (action === 'out') {
                chatbox.classList.add('flash-out');
            }

            setTimeout(() => {
                chatbox.classList.remove('flash-in', 'flash-out');
            }, 500);
        }

        async function refreshPresentList() {
            try {
                const response = await fetch('/fragment/present-list');
                const html = await response.text();

                const presentList = document.getElementById('present-list');
                presentList.innerHTML = html;

                const countResponse = await fetch('/api/present');
                const countData = await countResponse.json();
                document.getElementById('present-count').textContent = `(${countData.count})`;

                if (lightweightMode) {
                    applyFilter('LM');
                } else if (currentFilter !== 'all') {
                    applyFilter(currentFilter);
                }

            } catch (error) {
                console.error('Error refreshing present list:', error);
            }
        }

        function applyFilter(category) {
            const members = document.querySelectorAll('.member-item');
            const emptyState = document.querySelector('.empty');
            let visibleCount = 0;

            members.forEach(member => {
                const memberCategory = member.getAttribute('data-category');
                if (category === 'all' || memberCategory === category) {
                    member.style.display = '';
                    visibleCount++;
                } else {
                    member.style.display = 'none';
                }
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            if (emptyState) {
                emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
            }

            currentFilter = category;
        }

        async function checkLightweightMode() {
            try {
                const response = await fetch('/api/lightweight_mode');
                const data = await response.json();
                lightweightMode = data.enabled;

                const filterControls = document.getElementById('filter-controls');
                if (filterControls) {
                    if (lightweightMode) {
                        filterControls.style.display = 'none';
                        applyFilter('LM');
                    } else {
                        filterControls.style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Error checking lightweight mode:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const chatbox = document.getElementById('scanner-chatbox');
            const wasCollapsed = localStorage.getItem('chatboxCollapsed');
            if (wasCollapsed === 'false') {
                chatbox.classList.remove('collapsed');
            }

            checkForScans();
            checkLightweightMode();

            setInterval(checkForScans, pollInterval);
            setInterval(refreshPresentList, 10000);

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!lightweightMode) {
                        const category = this.getAttribute('data-category');
                        applyFilter(category);
                    }
                });
            });
        });
    </script>
</body>
</html>
