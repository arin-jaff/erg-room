<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who's In the Erg Room?</title>
    <script src="/static/htmx.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Scanner Chatbox */
        .scanner-chatbox {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            width: 320px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            border: 1px solid var(--gray-200);
            background: var(--white);
            font-size: 0.875rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .chatbox-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .chatbox-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .chatbox-header .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            position: relative;
            z-index: 1;
        }

        @keyframes pulse-dot {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.9);
            }
        }

        .chatbox-log {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            background: var(--gray-50);
            min-height: 180px;
            max-height: 280px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chatbox-log::-webkit-scrollbar {
            width: 8px;
        }

        .chatbox-log::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 1rem;
        }

        .chatbox-log::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            border-radius: 1rem;
        }

        .chatbox-log::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .chat-message {
            padding: 0.625rem 0.75rem;
            border-radius: 0.5rem;
            animation: slideInMessage 0.3s ease;
            border-left: 3px solid;
            background: var(--white);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .chat-message.in {
            border-left-color: var(--success);
            background: linear-gradient(90deg, var(--success-light) 0%, var(--white) 100%);
        }

        .chat-message.out {
            border-left-color: var(--error);
            background: linear-gradient(90deg, var(--error-light) 0%, var(--white) 100%);
        }

        .chat-message.registered {
            border-left-color: var(--primary);
            background: linear-gradient(90deg, rgba(68, 153, 217, 0.1) 0%, var(--white) 100%);
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message .timestamp {
            color: var(--gray-500);
            font-size: 0.7rem;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-weight: 500;
        }

        .chat-message .content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .chat-message .name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .chat-message .action-text {
            color: var(--gray-600);
            font-size: 0.85rem;
        }

        .chat-message.in .name {
            color: #065f46;
        }

        .chat-message.out .name {
            color: #991b1b;
        }

        .chat-message.registered .name {
            color: var(--primary-dark);
        }

        .chat-message .icon {
            font-size: 1.1rem;
        }

        .chatbox-empty {
            color: var(--gray-400);
            text-align: center;
            padding: 3rem 1rem;
            font-style: italic;
        }

        .chatbox-input {
            background: var(--white);
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--gray-200);
            font-size: 0.8rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chatbox-input .scan-icon {
            font-size: 1.25rem;
        }

        /* Flash effects for new messages */
        .scanner-chatbox.flash-in {
            animation: chatFlashIn 0.6s ease;
        }

        .scanner-chatbox.flash-out {
            animation: chatFlashOut 0.6s ease;
        }

        @keyframes chatFlashIn {
            0%, 100% { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
            50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.6), 0 0 60px rgba(16, 185, 129, 0.3); }
        }

        @keyframes chatFlashOut {
            0%, 100% { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.6), 0 0 60px rgba(239, 68, 68, 0.3); }
        }

        /* Present list updates */
        .member-grid {
            transition: all 0.3s ease;
        }

        .member-item.new-checkin {
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .scanner-chatbox {
                width: 280px;
                bottom: 5rem;
                right: 1rem;
            }

            .chatbox-log {
                min-height: 140px;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/static/c150lion1.png" alt="C150 Lion" class="header-lion left">
            <h1>Who's In the Erg Room?</h1>
            <img src="/static/c150lion1.png" alt="C150 Lion" class="header-lion right">
        </div>
    </header>

    <section>
        <h2>Currently Here <span id="present-count">({{ present|length }})</span></h2>
        <div id="present-list">
            {% include '_present_list.html' %}
        </div>
    </section>

    <!-- AOL-style Scanner Chatbox -->
    <div id="scanner-chatbox" class="scanner-chatbox">
        <div class="chatbox-header">
            <span class="status-dot"></span>
            <span>üì° Scanner Activity</span>
        </div>
        <div id="chatbox-log" class="chatbox-log">
            {% if scan_history %}
                {% for scan in scan_history %}
                <div class="chat-message {{ scan.action }}">
                    <div class="timestamp">{{ scan.timestamp[11:19] }}</div>
                    <div class="content">
                        <span class="icon">{% if scan.action == 'in' %}‚Üí{% elif scan.action == 'out' %}‚Üê{% else %}‚ú®{% endif %}</span>
                        <span class="name">{{ scan.member_name or 'Unknown' }}</span>
                        <span class="action-text">{% if scan.action == 'in' %}checked in{% elif scan.action == 'out' %}checked out{% else %}registered{% endif %}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="chatbox-empty">No activity yet...<br>Tap your tag to check in!</div>
            {% endif %}
        </div>
        <div class="chatbox-input">
            <span class="scan-icon">üè∑Ô∏è</span>
            <span>Tap RFID tag to check in/out</span>
        </div>
    </div>

    <footer>
        <a href="/login">Edit Profile</a>
        <a href="/admin/login">Admin</a>
    </footer>

    <script>
        // Track last scan timestamp to detect new scans
        let lastScanTimestamp = null;
        let pollInterval = 2000; // Check every 2 seconds
        
        // Format timestamp for display
        function formatTime(isoTimestamp) {
            if (!isoTimestamp) return '';
            return isoTimestamp.substring(11, 19);
        }
        
        // Poll for scan updates
        async function checkForScans() {
            try {
                const response = await fetch('/api/scan_history');
                const history = await response.json();
                
                if (history.length > 0) {
                    const latestTimestamp = history[0].timestamp;
                    
                    // Check if this is a new scan
                    if (latestTimestamp !== lastScanTimestamp) {
                        const isNewScan = lastScanTimestamp !== null;
                        lastScanTimestamp = latestTimestamp;
                        
                        // Update the chatbox
                        updateChatbox(history);
                        
                        // Flash animation for new scans
                        if (isNewScan) {
                            flashChatbox(history[0].action);
                            
                            // Refresh present list if check in/out
                            if (history[0].action === 'in' || history[0].action === 'out') {
                                refreshPresentList();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking for scans:', error);
            }
        }
        
        // Update the chatbox with history
        function updateChatbox(history) {
            const chatLog = document.getElementById('chatbox-log');
            
            if (history.length === 0) {
                chatLog.innerHTML = '<div class="chatbox-empty">No activity yet...<br>Tap your tag to check in!</div>';
                return;
            }
            
            let html = '';
            for (const scan of history) {
                const icon = scan.action === 'in' ? '‚Üí' : (scan.action === 'out' ? '‚Üê' : '‚ú®');
                const actionText = scan.action === 'in' ? 'checked in' : (scan.action === 'out' ? 'checked out' : 'registered');
                const name = scan.member_name || 'Unknown';
                
                html += `
                    <div class="chat-message ${scan.action}">
                        <div class="timestamp">${formatTime(scan.timestamp)}</div>
                        <div class="content">
                            <span class="icon">${icon}</span>
                            <span class="name">${name}</span>
                            <span class="action-text">${actionText}</span>
                        </div>
                    </div>
                `;
            }
            
            chatLog.innerHTML = html;
        }
        
        // Flash the chatbox for new scans
        function flashChatbox(action) {
            const chatbox = document.getElementById('scanner-chatbox');
            
            // Remove existing flash classes
            chatbox.classList.remove('flash-in', 'flash-out');
            
            // Trigger reflow to restart animation
            void chatbox.offsetWidth;
            
            // Add appropriate flash class
            if (action === 'in') {
                chatbox.classList.add('flash-in');
            } else if (action === 'out') {
                chatbox.classList.add('flash-out');
            }
            
            // Remove flash class after animation
            setTimeout(() => {
                chatbox.classList.remove('flash-in', 'flash-out');
            }, 500);
        }
        
        // Refresh the present list
        async function refreshPresentList() {
            try {
                const response = await fetch('/fragment/present-list');
                const html = await response.text();
                
                const presentList = document.getElementById('present-list');
                presentList.innerHTML = html;
                
                // Update count
                const countResponse = await fetch('/api/present');
                const countData = await countResponse.json();
                document.getElementById('present-count').textContent = `(${countData.count})`;
                
            } catch (error) {
                console.error('Error refreshing present list:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Get initial scan state
            checkForScans();
            
            // Start polling
            setInterval(checkForScans, pollInterval);
            
            // Also refresh present list periodically (less frequently)
            setInterval(refreshPresentList, 10000);
        });
    </script>
</body>
</html>
